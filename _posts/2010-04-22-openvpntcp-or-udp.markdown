---
comments: true
date: 2010-04-22 13:24:25
layout: post
slug: openvpntcp-or-udp
title: OpenVPN:TCP or UDP?
wordpress_id: 109
categories:
- 未分类
---

因为学校不知道用什么方法使基于PPTP协议的VPN即使连接上了也无法传送数据，不得不把solution转向OpenVPN。虽然OpenVPN配置比起PPTP来说简单的让我有点难以置信（具体参考之前的博文），但是比起它轻松的配置之后实际应用中遇到的问题让我头疼到想直接关机睡觉。
先是MTU的问题，client连接上后几分钟就断掉了。这个问题让我头疼了好几天最后GoogleN次后+twitter求助@yegle童鞋也顺利的解决了（具体还是请各位看官参考之前的博文）。
接下来进入正题。接下来几次连接都很正常（这几次都是在早上，准确的说是在9:00~11:00），但是到了晚上又碰到断线了。具体现象是在加密隧道在有大量数据传输时突然看到网络连接有一小段时间不活动了，接着所有网络请求都失败、服务器ping隧道另一端直接Time Out.并且在这之前在隧道无负载时隧道之间ping只维持在服务器到客户端的正常ping值，而当有大量数据请求时ping值明显增长甚至到2000~3000ms.接下来几天Google+Twitter寻找答案。参考官方文档，当隧道两端有明显延迟时建议将UDP改为TCP。当看到在这句话时我开始迷茫了，我一直都是用TCP的。而且《TCP/IP详解》上的定义也是TCP是面向连接的并且有出错重传机制，而UDP是无连接的。所以我就傻BB的一直以为用TCP就一定比UDP好。直到昨天，实在受不了了。看看Youtube，上上Twitter一晚上断线两三回，而且看Youtube速度巨慢。于是开了传说中的Wireshark来抓抓包看看有什么蛛丝马迹能给我some hint不。于是看到n多TCP Fast Retransmission！这个是虾米？当然我也没有人可以问，放Google搜之，原来是TCP数据包丢包之后的重传。在隧道负载比较轻的状态下大概每隔几十秒就有两组TCP快速重传，而在隧道有传输时每秒都有。这时候，我好像有点清楚了。是中国SB电信到美国的链路质量太差导致TCP丢包，这也是为什么一到晚上就比较容易断线的原因。当然下面解决的过程就很简单了在/etc/openvpn/server.conf中把协议改为UDP。那什么时候用TCP呢？可能只有在链路质量比较好的网络上和需要数据传输比较可靠的情况下才使用TCP协议。
浪费了这么多口水、浪费各位看官这么多时间，简单来讲用OpenVPN来翻墙的就用UDP协议，除非你就在米国（当然在米国还翻什么墙啊）。
最后，我照列要F.U.C.K中国国家防火墙和他的创始人方滨兴。(全文完)
